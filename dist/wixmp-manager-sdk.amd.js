(function(e){if(typeof exports=="object"&&typeof module!="undefined")module.exports=e(P);else if(typeof define=="function"&&define.amd)define("bluebird",["bluebird_original"],e);else{var t;typeof window!="undefined"?t=window:typeof global!="undefined"?t=global:typeof self!="undefined"&&(t=self),t.Promise=e(P)}})(function(e){return e.defer=function(){var t,n,r=new e(function(){t=arguments[0],n=arguments[1]});return r.cancellable(),{resolve:t,reject:n,promise:r}},e.prototype.abort=function(){this.cancel({message:"aborted_by_user",code:-100})},e.prototype.progress=function(e){return this._progressCallback=e,this},e.prototype.notify=function(e){return typeof this._progressCallback=="function"&&this._progressCallback(e),this},e}),define("src/utils/utils",["bluebird"],function(e){"use strict";function t(e,t,n){var r;return n?(r=t.map(n),t[r.indexOf(Math[e].apply(null,r))]):Math[e].apply(this,t)}var n={extend:function(e){var t=Array.prototype.slice.call(arguments,1);return t.forEach(function(t){typeof t=="object"&&t!==null&&Object.keys(t).forEach(function(n){e[n]=t[n]})}),e},merge:function(){var e=Object.prototype.hasOwnProperty;return Array.prototype.reduce.call(arguments,function(t,n){return Object.keys(t).forEach(function(r){e.call(n,r)&&(t[r]=n[r])}),Object.keys(n).forEach(function(e){t[e]=n[e]}),t},{})},bytesToSize:function(e){if(e===0)return"0 Byte";var t=1024,n=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],r=Math.floor(Math.log(e)/Math.log(t));return(e/Math.pow(t,r)).toPrecision(3)+" "+n[r]},partial:function(e){var t=Array.prototype.slice.call(arguments,1);return function(){var n=Array.prototype.slice.call(arguments);return e.apply(this,t.concat(n))}},getParameterByName:function(e,t){var n,r;return t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),n=new RegExp("[\\?&]"+t+"=([^&#]*)"),r=n.exec(e),r?decodeURIComponent(r[1].replace(/\+/g," ")):""},snakeToCamel:function(e){return e.replace(/(\_[a-z])/g,function(e){return e.toUpperCase().replace("_","")})},find:function(e,t){var n;return e.some(function(e){if(t(e)===!0)return n=e,!0}),n},encodeParams:function(e){var t=[],n=function(e,n){t[t.length]=encodeURIComponent(e)+"="+encodeURIComponent(n)};return Object.keys(e).forEach(function(t){n(t,e[t])}),t.join("&").replace(/%20/g,"+")},insertDataInTemplate:function(e,t){function n(e,t){return e=e.replace(/[()\[\]\.^$|?+]/g,"\\$&"),new RegExp(e,t)}return Object.keys(t).forEach(function(r){e=e.replace(n("#"+r+"#","g"),t[r])}),e},transformModeToVangogh:function(e){var t={fill:"srz",fit:"srb"};return t[e]},splitTags:function(e){return e?Array.isArray(e)?e:e.split(/\s*,\s*/):[]},normalizeUri:function(e){if(typeof e!="string")throw new Error("URI is not a string");return e.replace(/([a-z\-_0-9]+)\/\//gi,"$1/")},getScript:function(t){return new e(function(e,n){var r=document.getElementsByTagName("head")[0],i=document.createElement("script"),s=!1;i.src=t,i.onload=i.onreadystatechange=function(){!s&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")?(s=!0,e(),i.onload=i.onreadystatechange=null,r&&i.parentNode&&r.removeChild(i)):n()},r.insertBefore(i,r.firstChild)})},isGuid:function(e){return/^\w{8}-(\w{4}-){3}\w{12}$/.test(e)}};return n.min=n.partial(t,"min"),n.max=n.partial(t,"max"),n}),define("src/utils/mappers",[],function(){"use strict";return{toObject:function(e){return e?typeof e=="string"?["{","["].indexOf(e[0])>=0?JSON.parse(e):{message:e}:e:null},toError:function(e){return{code:e.status,message:e.statusText||e.message||e.data.message||e.data.error&&e.data.error.message||"",data:e.data&&(e.data.errors||e.data.error||e.data)}}}}),define("src/utils/http",["bluebird","./utils","./mappers"],function(e,t,n){"use strict";function i(e){return typeof e=="string"&&(["{","["].indexOf(e[0])>=0?e=JSON.parse(e):e={message:e}),e}function s(e){return{status:e.status,statusText:e.statusText,data:i(e.responseText)}}function o(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function u(r,i,o){var u=new e(function(e,i){r.addEventListener("error",function(){i(n.toError(t.extend({},r,{message:"error",code:-201})))},!1),r.addEventListener("timeout",function(){i(n.toError(t.extend({},r,{message:"timeout_has_exceeded",code:408})))},!1),r.addEventListener("load",function(){r.status.toString().match(/^2\d+/i)?e(s(r)):i(n.toError(t.extend({},r,{message:"error",code:r.status,data:n.toObject(r.responseText)})))},!1)});return o?r.upload.onprogress=function(e){var t=Math.round(e.lengthComputable?e.loaded*100/e.total:0),n=t<=99?"uploading":"processing";u.notify({status:n,total:e.total,loaded:e.loaded})}:(r.addEventListener("loadstart",function(e){if(!e)return;u.notify({status:"uploading",total:e.total,loaded:e.loaded})},!1),r.addEventListener("loadend",function(e){if(!e)return;u.notify({status:"processing",total:e.total,loaded:e.loaded})},!1)),u.cancellable().catch(function(e){e.message==="aborted_by_user"&&r.abort()}),i(),u}function a(e,t){if(!t)return e;var n=[];return Object.keys(t).forEach(function(e){var r=t[e];if(r===null||typeof r=="undefined")return;r instanceof Array||(r=[r]),r.forEach(function(t){t instanceof Date&&!isNaN(t.valueOf())?t=t.toISOString():typeof t=="object"&&(t=JSON.stringify(t)),n.push(o(e)+"="+o(t))})}),n.length>0&&(e+=(e.indexOf("?")===-1?"?":"&")+n.join("&")),e}function f(e,n,r){var i=new XMLHttpRequest;return r.cache===!1&&(n+=(n.indexOf("?")===-1?"?":"&")+"_="+Date.now()),i.open(e.toUpperCase(),t.normalizeUri(n)),i.responseType=r.responseType,i.withCredentials=r.withCredentials,Object.keys(r.headers).forEach(function(e){i.setRequestHeader(e,r.headers[e])}),i}function l(e,n,i){var s=f("get",a(e,n),t.extend({},r,i));return u(s,function(){s.send(null)})}function c(e,n,i){var s=f("post",e,t.extend({},r,{headers:{"Content-Type":"application/json;charset=UTF-8"}},i));return u(s,function(){n&&typeof n=="object"&&n instanceof FormData==0&&(n=JSON.stringify(n)),s.send(n)})}function h(e,n,i){var s,o=f("post",e,t.extend({},r,i));return s=new FormData,Object.keys(n).forEach(function(e){var t=n[e],r=e==="file"?[e,t,t.name]:[e,t];return s.append.apply(s,r)}),u(o,function(){o.send(s)},!0)}function p(t){return function(){function s(){return t.apply(n,r)}var n=this,r=arguments,i;i=s();var o=new e(function(t,n){i.then(t,function(t){return t.message==="aborted_by_user"?(n(t),e.reject(t)):s()}).then(t,n)});return i.progress(function(e){o.notify(e)}),o.cancellable().catch(function(e){e.message==="aborted_by_user"&&i.abort()}),o}}var r={withCredentials:!1,cache:!0,headers:{Accept:"application/json, text/plain, */*"}};return{get:p(l),post:p(c),upload:p(h)}}),define("src/events/notifier",["bluebird"],function(e){"use strict";function n(){}function r(e,t){e.forEach(function(e){e(t)})}function i(e,t,n){e.forEach(function(e){e[t](n)})}function s(r,s,o){if(typeof t[s]=="undefined")return{resolveAt:n,rejectAt:n};var u=[],a=[];return t[s].forEach(function(t){var n=[],r=[],i=o.promises.map(function(){return new e(function(e,t){n.push(e),r.push(t)})});u.push(n),a.push(r),t(i,o)}),{resolveAt:function(e,t){i(u,e,t)},rejectAt:function(e,t){i(a,e,t)}}}function o(i,o,u){if(typeof i!="object"||i===null)throw new Error("target should be a function");if(typeof o!="string")throw new Error("eventName should be a string");u=u||{},u.eventTarget=i,u.eventName=o;if(u.promises&&u.promises.length)return s(i,o,u);if(typeof t[o]=="undefined")return{resolve:n,reject:n};var a=[],f=[];return t[o].forEach(function(t){var n=new e(function(e,t){a.push(e),f.push(t)});t(n,u)}),{resolve:function(e){r(a,e)},reject:function(e){r(f,e)}}}function u(e,n){typeof t[e]=="undefined"&&(t[e]=[]),t[e].push(n)}function a(e,n){if(t[e]){var r=t[e].indexOf(n);t[e].splice(r,1)}}var t={};return{emit:o,addListener:u,removeListener:a}}),define("src/sources/Source",["../utils/http","../events/notifier"],function(e,t){"use strict";return function(n,r){if(typeof n!="function")throw new Error("Source constructor should be a function");if(typeof r=="undefined"||typeof r=="object"&&r!==null)return new n(r,t.emit,e);throw new Error("Source settings should be an object")}}),define("src/sources/private/mappers/folder",[],function(){"use strict";return function(e){return{id:e.folder_id,parentId:e.parent_folder_id||null,name:e.folder_name,mediaType:e.media_type,filesCount:e.files_count,createdAt:e.created_ts}}}),define("src/sources/private/parsers/error",["bluebird","../../../utils/mappers"],function(e){"use strict";return function(t){return t.status===403&&t.data.error_description==="Missing Wix session"&&(t.status=401,t.data.message="Wix Session required"),e.reject(t)}}),define("src/sources/private/folders",["../../utils/http","./mappers/folder","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return n(e)}function s(n,s){return s=s||{},e.get(r.apiUrl+"/folders",{media_type:s.mediaType||"picture",folder_id:n||null},{withCredentials:!0}).then(function(e){return{data:e.data.folders.map(t)}}).catch(i)}function o(t){return e.post(r.apiUrl+"/folders/"+t+"/delete",null,{withCredentials:!0}).then(function(){return t}).catch(i)}function u(e){return e.map(o)}return{list:s,remove:u}}}),define("src/sources/private/validators/new-props",[],function(){"use strict";return function(e){return typeof e!="object"||e===null?{valid:!1,message:"Please specify new props"}:typeof e.name!="undefined"&&!e.name?{valid:!1,message:"Please specify name"}:typeof e.folderId!="undefined"&&!e.folderId?{valid:!1,message:"Please specify folder id"}:typeof e.parentId!="undefined"&&!e.parentId?{valid:!1,message:"Please specify parent folder id"}:typeof e.tags!="undefined"&&!Array.isArray(e.tags)?{valid:!1,message:"Tags should be an array"}:{valid:!0}}}),define("src/sources/private/folder",["../../utils/http","../../utils/mappers","../../utils/utils","./mappers/folder","./parsers/error","./validators/new-props"],function(e,t,n,r,i,s){"use strict";return function(o){function u(e){return i(e)}function a(n,i){return n?(i=i||{},e.post(o.apiUrl+"/folders",{folder_name:n,media_type:i.mediaType||"picture",parent_folder_id:i.parentId||null},{withCredentials:!0}).then(function(e){return e.data=r(e.data),e}).catch(u)):u(t.toError({status:-200,statusText:"Internal JS Error",data:{message:"Please specify name"}}))}function f(r,i){var a=s(i);if(a.valid===!1)return u(t.toError({status:-200,statusText:"Internal JS Error",data:{message:a.message}}));var f={};return i.name&&(f.folder_name=i.name),i.parentId&&(f.parent_folder_id=i.parentId),e.post(o.apiUrl+"/folders/"+r.id+"/put",f,{withCredentials:!0}).then(function(e){return e.data=n.extend({},r,i),e}).catch(u)}return{create:a,update:f}}}),define("src/sources/private/mappers/item",["../../../utils/mappers","../../../utils/utils"],function(e,t){"use strict";function r(e,t,r){function s(e){return r?e:e.replace(i,"")}function o(e){return i.exec(e)[1]}var i=/([^\/]+)$/,u={};e.file_url&&(u.original=n(t.filesUrl+"/"+e.file_url)),e.icon_url&&(u.thumbnail=n(t.filesUrl+"/"+e.icon_url));switch(e.media_type){case"picture":case"site_icon":e.file_url&&(u.thumbnail=n(t.filesUrl+"/"+s(e.file_url)+"/v1/#mode#/w_#width#,h_#height#/"+o(e.file_url)));break;case"video":u.thumbnail=e.icon_url?n(t.filesUrl+"/"+e.icon_url):"./images/video-preview.png";break;case"ufonts":u.preview=n(t.filesUrl+"/media"+e.file_name.replace(/\..*/,"")+"_prvw.jpg");break;default:}return u}function i(e,t){var r={};e.file_url&&(r.original=n(t.filesUrl+"/"+e.file_url)),e.icon_url&&(r.thumbnail=n(t.filesUrl+"/"+e.icon_url));switch(e.media_type){case"picture":case"site_icon":e.file_url&&(r.thumbnail=n(t.filesUrl+"/"+e.file_url+"_#mode#_#width#_#height#_75_22_0.5_1.20_0.00_jpg_#mode#"));break;case"ufonts":r.preview=n(t.filesUrl+"/media"+e.file_name.replace(/\..*/,"")+"_prvw.jpg");break;default:}return r}function s(e,t){return t.imageOperationsApi==="rembrandt"?r(e,t):t.imageOperationsApi==="vanbrandt"?r(e,t,!0):i(e,t)}var n=t.normalizeUri;return function(r,i,o,u){function a(e){return Object.keys(o).reduce(function(n,r){var s=r+"Url",u=t.extend({},o[r]),a=e[r]||e.thumbnail;return a?(i.imageOperationsApi==="vangogh"&&(u.mode=t.transformModeToVangogh(u.mode)),n[s]=t.insertDataInTemplate(a,u),n):n},{})}var f=u?undefined:null,l={id:r.file_name,folderId:r.parent_folder_id||f,name:r.original_file_name,mediaType:r.media_type,fileUrl:r.file_url?n(r.file_url):f,createdAt:r.created_ts,tags:t.splitTags(r.tags),width:r.width||f,height:r.height||f,fileInfo:r.file_info?e.toObject(r.file_info):f,fileInput:r.file_input?e.toObject(r.file_input):f,fileOutput:r.file_output?e.toObject(r.file_output):f,transcodingStatus:r.op_status};return o=t.extend({},i.thumbnailSizes,o),t.extend(l,a(s(r,i))),Object.keys(l).forEach(function(e){l[e]===undefined&&delete l[e]}),l}}),define("src/sources/private/items",["bluebird","../../utils/http","../../utils/utils","./mappers/item","./parsers/error"],function(e,t,n,r,i){"use strict";return function(e){function s(e){return i(e)}function o(t,n){return t.data.files?t.data.files.map(function(t){return r(t,e,n)}):[]}function f(r,i){i=i||{};var f=n.extend({},a,i.sort),l=n.extend({},u,i.paging),c={page_size:l.size,cursor:l.cursor,parent_folder_id:r,media_type:i.mediaType||"picture"};return c.order=f.direction==="desc"?"-"+f.order:f.order,t.get(e.apiUrl+"/files/getpage",c,{withCredentials:!0}).then(function(e){return{data:o(e,i.thumbnails),paging:{size:l.size,cursor:e.data.cursor}}}).catch(s)}function l(n){return t.post(e.apiUrl+"/files/"+n+"/delete",null,{withCredentials:!0}).then(function(){return n}).catch(s)}function c(e){return e.map(l)}function h(r,i){i=i||{};var f=n.extend({},a,i.sort),l=n.extend({},u,i.paging),c={page_size:l.size,cursor:l.cursor,media_type:i.mediaType||"picture",order:f.direction==="desc"?"-"+f.order:f.order};return t.get(e.apiUrl+"/files/get?tag="+r,c,{withCredentials:!0,cache:!1}).then(function(e){return{data:o(e),paging:{size:l.size,cursor:e.data.cursor}}}).catch(s)}var u={size:50,cursor:null},a={order:"date",direction:"desc"};return{list:f,remove:c,searchByTag:h}}}),define("src/sources/private/item",["bluebird","../../utils/http","../../utils/utils","./mappers/item","./parsers/error","./validators/new-props","../../utils/mappers"],function(e,t,n,r,i,s,o){"use strict";return function(u){function f(e){return u.uploadLimits[n.snakeToCamel(e)]}function l(e){return e.file.size>=f(e.mediaType)}function c(e){typeof e=="function"&&a.push(e)}function h(e){return i(e)}function p(e){function n(e){return e==="secure_music"?"music-goods/upload":e==="video"?"video/upload":"upload"}return t.get(u.apiUrl+"/files/"+n(e.mediaType)+"/url",{media_type:e.mediaType,file_name:e.name,file_size:e.size,content_type:e.file.type},{withCredentials:!0})}function d(e){var i={url:encodeURIComponent(n.normalizeUri(e.url)),media_type:e.mediaType,name:e.name||"Untitled",tags:(e.tags||[]).join(",")||null,parent_folder_id:e.folderId||null},s=u.apiUrl+"/files/upload/external?url="+i.url+"&media_type="+i.media_type,o=t.post(s,i,{withCredentials:!0}).progress(function(e){o.notify(e)}).then(function(e){return r(e.data,u)});return o}function v(i){var s={parent_folder_id:i.folderId||null,file:i.file,media_type:i.mediaType};if(l(i))return e.reject(o.toError({status:-406,statusText:"Not Acceptable",data:{error_description:"File size is bigger than "+n.bytesToSize(f(i.mediaType))}}));var a=p(i).then(function(e){return s.upload_token=e.data.upload_token,t.upload(e.data.upload_url,s,{withCredentials:!0}).progress(function(e){a.notify(e)})}).then(function(e){return r(e.data[0],u)});return a}function m(e){return t.get(u.apiUrl+"/files/"+e,null,{withCredentials:!0,cache:!1}).then(function(e){return r(e.data,u)}).catch(h)}function g(e,r){var i=s(r);if(i.valid===!1)return h(o.toError({status:-200,statusText:"Internal JS Error",data:{message:i.message}}));var a={};return r.name&&(a.original_file_name=r.name),r.folderId&&(a.parent_folder_id=r.folderId),r.tags&&(a.tags=r.tags.join(",")),t.post(u.apiUrl+"/files/"+e.id+"/put",a,{withCredentials:!0}).then(function(t){return t.data=n.extend({},e,r),t}).catch(h)}var a=[];return{onItemUploadProgress:c,upload:v,uploadByUrl:d,get:m,update:g}}}),define("src/sources/private/items.trash",["bluebird","../../utils/http","../../utils/utils","./mappers/item","./parsers/error"],function(e,t,n,r,i){"use strict";return function(e){function s(e){return i(e)}function o(t,n){return t.data.trash_files?t.data.trash_files.map(function(t){return r(t,e,n)}):[]}function f(r,i){i=i||{};var f=n.extend({},a,i.sort),l=n.extend({},u,i.paging),c={page_size:l.size,cursor:l.cursor,parent_folder_id:r,media_type:i.mediaType||"picture"};return c.order=f.direction==="desc"?"-"+f.order:f.order,t.get(e.apiUrl+"/files/getpage/trash",c,{withCredentials:!0}).then(function(e){return{data:o(e,i.thumbnails),paging:{size:l.size,cursor:e.data.cursor}}}).then(function(e){return e.data.forEach(function(e){e.isInTrash=!0}),e}).catch(s)}function l(n){return t.post(e.apiUrl+"/trash/files/"+n+"/delete",null,{withCredentials:!0}).then(function(){return n}).catch(s)}function c(e){return e.map(l)}function h(n){return t.post(e.apiUrl+"/trash/files/"+n+"/restore",null,{withCredentials:!0}).then(function(){return n}).catch(s)}function p(e){return e.map(h)}var u={size:50,cursor:null},a={order:"date",direction:"desc"};return{list:f,remove:c,restore:p}}}),define("src/sources/private/folders.trash",["bluebird","../../utils/http","../../utils/utils","./mappers/folder","./parsers/error"],function(e,t,n,r,i){"use strict";return function(e){function n(e){return i(e)}function s(i,s){return s=s||{},t.get(e.apiUrl+"/files/getpage/trash",{media_type:s.mediaType||"picture",folder_id:i||null,trash_type:"folder"},{withCredentials:!0}).then(function(e){return{data:e.data.trash_folders.map(r)}}).then(function(e){return e.data.forEach(function(e){e.isInTrash=!0}),e}).catch(n)}function o(r){return t.post(e.apiUrl+"/trash/folders/"+r+"/delete",null,{withCredentials:!0}).then(function(){return r}).catch(n)}function u(e){return e.map(o)}function a(r){return t.post(e.apiUrl+"/trash/folders/"+r+"/restore",null,{withCredentials:!0}).then(function(){return r}).catch(n)}function f(e){return e.map(a)}return{list:s,remove:u,restore:f}}}),define("src/sources/private/settings",[],function(){"use strict";return{apiUrl:"//files.wix.com",imageOperationsApi:"vangogh",filesUrl:"//static.wixstatic.com",uploadLimits:{"default":15728640,document:15728640,picture:15728640,music:52428800,video:524288e3,secureMusic:377487360},thumbnailSizes:{thumbnail:{width:210,height:210,mode:"fill"},preview:{width:375,height:375,mode:"fit"},original:{width:1e3,height:1e3,mode:"fit"}},channel:{withCredentials:!0,jsapiUrl:"/_ah/channel/jsapi",tokenUrl:"/users/channel"}}}),define("src/sources/decorators",["bluebird","../events/notifier","../utils/utils"],function(e,t,n){"use strict";function r(i,s,o){var u={};return Object.keys(s).forEach(function(a){var f=n.snakeToCamel(a.toLowerCase());if(typeof o[f]=="object"&&o[f]!==null&&typeof s[a]=="object"&&s[a]!==null){u[f]=r(i,s[a],o[f]);return}if(typeof o[f]!="function")return;u[f]=function(){var n=arguments,r=o[f].apply(o,n),u={arguments:n},l,c;return Array.isArray(r)?(u.promises=r,l=t.emit(i,s[a],u),r.forEach(function(e,t){var n=e.then(function(e){l.resolveAt(t,e)},function(e){l.rejectAt(t,e)});e.progress(function(e){n.notify(e)})}),r):(l=t.emit(i,s[a],u),c=r.then(function(e){return l.resolve(e),e},function(t){return l.reject(t),e.reject(t)}),r.progress(function(e){c.notify(e)}),c)}}),u}return{addEvents:r}}),define("src/events/list",[],function(){"use strict";return{FOLDERS:{LIST:"folders.list",REMOVE:"folders.remove",TRASH:{LIST:"folders.trash.list",RESTORE:"folders.trash.restore",REMOVE:"folders.trash.remove"}},FOLDER:{CREATE:"folder.create",UPDATE:"folder.update",REMOVE:"folder.remove"},ITEMS:{LIST:"items.list",SEARCH:"items.search",REMOVE:"items.remove",UPLOAD:"items.upload",UPLOAD_BY_URL:"items.uploadByUrl",SEARCH_BY_TAG:"items.searchByTag",TRASH:{LIST:"items.trash.list",RESTORE:"items.trash.restore",REMOVE:"items.trash.remove"}},ITEM:{GET:"item.get",UPDATE:"item.update",REMOVE:"item.remove",UPLOAD:"item.upload",UPLOAD_BY_URL:"item.uploadByUrl"}}}),define("src/services/channel/channel",["bluebird","../../utils/http","../../utils/utils","../../events/notifier","../../events/list"],function(e,t,n,r,i){"use strict";return function(s,o,u){function c(){function c(e){console.log("message received:",e);if(e.data==="server connected")return;try{e=JSON.parse(e.data),console.log(e);if(e.type==="status_update"){var t=u(e.file,s,{},!0);console.log(t);var n=r.emit(o,i.ITEM.UPDATE,{arguments:[t,t]});n.resolve({data:t})}}catch(a){console.log("something is wrong:",a,a.stack)}}function h(){console.log("socket is closing"),a=null,f=null}var p=e.defer();if(a&&f)p.resolve();else{var d;l?d=e.resolve():d=n.getScript(s.apiUrl+s.channel.jsapiUrl).then(function(){l=!0}),d.then(function(){return t.get(s.apiUrl+s.channel.tokenUrl,null,{withCredentials:s.channel.withCredentials})}).then(function(e){a=new goog.appengine.Channel(e.data.token),f=a.open(),f.onmessage=c,f.onclose=h,p.resolve()}).catch(function(e){console.log("something is wrong:",e),p.reject(e)})}return p.promise}function h(){f&&(f.close(),a=null,f=null)}var a=null,f=null,l=!1;return{open:c,close:h}}}),define("src/sources/private/Private",["./folders","./folder","./items","./item","./items.trash","./folders.trash","./mappers/item","./settings","../../utils/utils","../decorators","../../events/list","../../services/channel/channel"],function(e,t,n,r,i,s,o,u,a,f,l,c){"use strict";return function(h){var p=a.extend({},u,h),d=e(p),v=t(p),m=n(p),g=r(p),y=i(p),b=s(p),w=c(p,this,o);d.trash=b,m.trash=y,this.name="private",this.folders=f.addEvents(this,l.FOLDERS,d),this.folder=f.addEvents(this,l.FOLDER,v),this.item=f.addEvents(this,l.ITEM,g),this.items=f.addEvents(this,l.ITEMS,m),this.channel=w}}),define("src/sources/picasa/settings",[],function(){"use strict";return{apiUrl:"//pix.wix.com/services/google",foldersLimit:500,itemsLimit:50}}),define("src/sources/picasa/mappers/folder",[],function(){"use strict";return function(e){return{id:e.gphoto$id.$t,name:e.title.$t,mediaType:"picture",parentId:null,filesCount:e.gphoto$numphotos.$t,createdAt:e.published.$t}}}),define("src/sources/picasa/parsers/folders",["../mappers/folder"],function(e){"use strict";return function(t){return{data:t.feed.entry.map(e)}}}),define("src/sources/picasa/parsers/error",["bluebird"],function(e){"use strict";return function(t){return e.reject(t)}}),define("src/sources/picasa/folders",["../../utils/http","./parsers/folders","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(t,n){n=n||{},n.paging=n.paging||{};var o={thumbsize:"150c","max-results":n.paging.pageSize||r.foldersLimit,"start-index":n.paging.cursor||1};return e.get(r.apiUrl+"/albums",o,{withCredentials:!0}).then(i).catch(s)}return{list:o}}}),define("src/sources/picasa/mappers/item",["../../../utils/utils"],function(e){"use strict";function t(e){var t=e.media$thumbnail.filter(function(e){return!e.medium||e.medium!=="video"});return t[t.length-1].url||""}return function(n){var r,i,s,o,u;return r=t(n.media$group),i=+n.gphoto$width.$t||1024,s=+n.gphoto$height.$t||768,o=r.replace(/\/s[0-9]+/,"/w"+i+"-h"+s+"-no"),i>400?u=r.replace(/\/s[0-9]+(-c)?/,"/s400"):u=o,{id:n.id.$t,name:n.summary.$t||n.title.$t,mediaType:"picture",fileUrl:e.normalizeUri(o),thumbnailUrl:e.normalizeUri(r),previewUrl:e.normalizeUri(u),createdAt:n.published.$t,tags:[],width:i,height:s}}}),define("src/sources/picasa/parsers/items",["../mappers/item"],function(e){"use strict";return function(t){return{data:t.feed.entry.map(e),paging:{cursor:t.feed.openSearch$startIndex.$t+t.feed.openSearch$itemsPerPage.$t,pageSize:t.feed.openSearch$itemsPerPage.$t}}}}),define("src/sources/picasa/items",["../../utils/http","./parsers/items","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(t,n){n=n||{},n.paging=n.paging||{};var o={album_id:t||null,kind:"photo",thumbsize:"150c","max-results":n.paging.pageSize||r.itemsLimit,"start-index":n.paging.cursor||1};return e.get(r.apiUrl+"/photos",o,{withCredentials:!0}).then(i,s)}return{list:o}}}),define("src/sources/picasa/Picasa",["./settings","./folders","./items","../decorators","../../events/list"],function(e,t,n,r,i){"use strict";return function(){var s=t(e),o=n(e);this.folders=r.addEvents(this,i.FOLDERS,s),this.items=r.addEvents(this,i.ITEMS,o),this.name="picasa"}}),define("src/sources/instagram/settings",[],function(){"use strict";return{apiUrl:"//pix.wix.com/services/instagram",api2Url:"//pix.wix.com/services/instagram2"}}),define("src/sources/instagram/mappers/folder",[],function(){"use strict";return function(e){return{id:"Instagram",name:"Instagram",mediaType:"picture",parentId:null,filesCount:e.counts.media,createdAt:null}}}),define("src/sources/instagram/parsers/folders",["../mappers/folder"],function(e){"use strict";return function(t){return{data:[e(t)]}}}),define("src/sources/instagram/parsers/error",["bluebird"],function(e){"use strict";return function(t){return t.code===500&&(t.code=403,t.data={message:"Unauthorized",result:"error"}),e.reject(t)}}),define("src/sources/instagram/folders",["../../utils/http","./parsers/folders","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(){return e.get(r.apiUrl+"/user",null,{withCredentials:!0}).then(i,s)}return{list:o}}}),define("src/sources/instagram/mappers/item",["../../../utils/utils"],function(e){"use strict";return function(t){return t.caption||(t.caption={text:""}),{id:t.id,name:t.caption.text,mediaType:"picture",fileUrl:e.normalizeUri(t.images.standard_resolution.url),thumbnailUrl:e.normalizeUri(t.images.low_resolution.url),previewUrl:e.normalizeUri(t.images.standard_resolution.url),createdAt:+t.created_time*1e3,tags:e.splitTags(t.tags),width:t.images.standard_resolution.width,height:t.images.standard_resolution.height}}}),define("src/sources/instagram/parsers/items",["../mappers/item"],function(e){"use strict";return function(t){t.next=t.next||{};var n=t.next.max_id||null,r=t.next.count||null;return{data:t.photos.map(e),paging:{cursor:n,pageSize:r}}}}),define("src/sources/instagram/items",["../../utils/http","./parsers/items","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(t,n){n=n||{},n.paging=n.paging||{};var o={count:n.paging.pageSize||50,max_id:n.paging.cursor||null};return e.get(r.api2Url+"/photos",o,{withCredentials:!0}).then(i,s)}return{list:o}}}),define("src/sources/instagram/Instagram",["./settings","./folders","./items","../decorators","../../events/list"],function(e,t,n,r,i){"use strict";return function(){var s=t(e),o=n(e);this.name="instagram",this.folders=r.addEvents(this,i.FOLDERS,s),this.items=r.addEvents(this,i.ITEMS,o)}}),define("src/sources/facebook/settings",[],function(){"use strict";return{apiUrl:"//pix.wix.com/services/facebook2",foldersLimit:50,itemsLimit:50}}),define("src/sources/facebook/mappers/folder",[],function(){"use strict";return function(e){return{id:e.id,name:e.name,mediaType:"picture",parentId:null,filesCount:e.count,createdAt:e.created_time}}}),define("src/sources/facebook/parsers/folders",["../mappers/folder"],function(e){"use strict";return function(t){return{data:t.data.map(e)}}}),define("src/sources/facebook/parsers/error",["bluebird"],function(e){"use strict";return function(t){return t.code===400&&t.data.code===190&&(t.code=403),e.reject(t)}}),define("src/sources/facebook/folders",["../../utils/http","./parsers/folders","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(t,n){n=n||{},n.paging=n.paging||{};var o={limit:n.paging.pageSize||r.foldersLimit,after:n.paging.cursor||null};return e.get(r.apiUrl+"/albums",o,{withCredentials:!0}).then(i,s)}return{list:o}}}),define("src/sources/facebook/mappers/item",["../../../utils/utils"],function(e){"use strict";function t(t,n,r){r=r||190,n=n||190;var i,s,o;return t.length===1?t[0].source:(i=t.filter(function(e){return e.width>n&&e.height>r}),o=e.min(i,function(e){return e.width+e.height}),o?o.source:(s=e.max(t,function(e){return e.width+e.height}),s.source))}return function(n){return{id:n.id,folderId:null,name:n.name||"",mediaType:"picture",fileUrl:e.normalizeUri(n.source),thumbnailUrl:e.normalizeUri(t(n.images)),previewUrl:e.normalizeUri(n.source),createdAt:n.created_time,tags:[],width:n.width,height:n.height}}}),define("src/sources/facebook/parsers/items",["../mappers/item"],function(e){"use strict";return function(t){return t.paging=t.paging||{},t.paging.cursors=t.paging.cursors||{},t.paging.cursors.after=t.paging.cursors.after||null,{data:t.data.map(e),paging:{cursor:t.paging.cursors.after,pageSize:null}}}}),define("src/sources/facebook/items",["../../utils/http","./parsers/items","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(t,n){n=n||{},n.paging=n.paging||{};var o={album_id:t,limit:n.paging.pageSize||r.itemsLimit,after:n.paging.cursor||null};return e.get(r.apiUrl+"/photos",o,{withCredentials:!0}).then(i,s)}return{list:o}}}),define("src/sources/facebook/Facebook",["./settings","./folders","./items","../decorators","../../events/list"],function(e,t,n,r,i){"use strict";return function(){var s=t(e),o=n(e);this.name="facebook",this.folders=r.addEvents(this,i.FOLDERS,s),this.items=r.addEvents(this,i.ITEMS,o)}}),define("src/sources/flickr/settings",[],function(){"use strict";return{apiUrl:"//pix.wix.com/services/flickr",foldersLimit:50,itemsLimit:50}}),define("src/sources/flickr/mappers/folder",[],function(){"use strict";return function(e){return{id:e.id,name:e.title._content,mediaType:"picture",parentId:null,filesCount:+e.photos+ +e.videos,createdAt:+e.date_create*1e3}}}),define("src/sources/flickr/parsers/folders",["../mappers/folder"],function(e){"use strict";return function(t){return{data:t.photosets.photoset.map(e)}}}),define("src/sources/flickr/parsers/error",["bluebird"],function(e){"use strict";return function(t){return e.reject(t)}}),define("src/sources/flickr/folders",["../../utils/http","./parsers/folders","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(t,n){n=n||{},n.paging=n.paging||{};var o={primary_photo_extras:"url_t,url_s,url_m,url_b,url_o",per_page:n.paging.pageSize||r.foldersLimit,page:n.paging.cursor||null};return e.get(r.apiUrl+"/albums",o,{withCredentials:!0}).then(i,s)}return{list:o}}}),define("src/sources/flickr/mappers/item",["../../../utils/utils"],function(e){"use strict";function t(e){var t=e.url_m||e.url_s||e.url_t,n=e.url_b||t,r=e.url_o||n;return{fileUrl:r,thumbnailUrl:t,previewUrl:n}}return function(n){var r=t(n);return{id:n.id,name:n.title,folderId:null,mediaType:"picture",fileUrl:e.normalizeUri(r.fileUrl),thumbnailUrl:e.normalizeUri(r.thumbnailUrl),previewUrl:e.normalizeUri(r.previewUrl),createdAt:null,tags:[],width:+(n.width_o||n.width_m||n.width_s||n.width_t),height:+(n.height_o||n.height_m||n.height_s||n.height_t)}}}),define("src/sources/flickr/parsers/items",["../mappers/item"],function(e){"use strict";return function(t){var n=t.photoset.page<t.photoset.pages?t.photoset.page+1:null,r=+t.photoset.perpage;return{data:t.photoset.photo.map(e),paging:{cursor:n,pageSize:r}}}}),define("src/sources/flickr/items",["../../utils/http","./parsers/items","./parsers/error"],function(e,t,n){"use strict";return function(r){function i(e){return t(e.data)}function s(e){return n(e)}function o(t,n){n=n||{},n.paging=n.paging||{};var o={extras:"url_t,url_s,url_m,url_b,url_o",set_id:t,per_page:n.paging.pageSize||r.itemsLimit,page:n.paging.cursor||null};return e.get(r.apiUrl+"/photoset",o,{withCredentials:!0}).then(i).catch(s)}return{list:o}}}),define("src/sources/flickr/Flickr",["./settings","./folders","./items","../decorators","../../events/list"],function(e,t,n,r,i){"use strict";return function(){var s=t(e),o=n(e);this.name="flickr",this.folders=r.addEvents(this,i.FOLDERS,s),this.items=r.addEvents(this,i.ITEMS,o)}}),define("src/sources/list",["./private/Private","./picasa/Picasa","./instagram/Instagram","./facebook/Facebook","./flickr/Flickr"],function(e,t,n,r,i){"use strict";var s={PRIVATE:e,PICASA:t,INSTAGRAM:n,FACEBOOK:r,FLICKR:i};return s}),define("src/events/events",["./notifier","./list","../utils/utils"],function(e,t,n){"use strict";function i(e,t){Object.defineProperty(r,e,{enumerable:!1,value:t})}var r=n.merge(t);return i("on",e.addListener),i("off",e.removeListener),r}),define("src/connector/connector-settings",[],function(){"use strict";return{PICASA:{connectUrl:"//pix.wix.com/services/google/connect",disconnectUrl:"//pix.wix.com/services/google/disconnect",parameterName:"goglact"},INSTAGRAM:{connectUrl:"//pix.wix.com/services/instagram/connect",disconnectUrl:"//pix.wix.com/services/instagram/disconnect",parameterName:"instact"},FACEBOOK:{connectUrl:"//pix.wix.com/services/facebook/connect",disconnectUrl:"//pix.wix.com/services/facebook/disconnect",parameterName:"fbact"},FLICKR:{connectUrl:"//pix.wix.com/services/flickr/connect",disconnectUrl:"//pix.wix.com/services/flickr/disconnect",parameterName:"flact"}}}),define("src/connector/connector",["bluebird","./connector-settings","../utils/http","../utils/utils"],function(e,t,n,r){"use strict";return function(i,s){function u(){return o.parameterName}function a(){return!!localStorage.getItem(o.parameterName)}function f(){return localStorage.removeItem(o.parameterName),n.get(o.disconnectUrl,null,{withCredentials:!0})}function l(){var t;return window.open(o.connectUrl+"?return_url="+s.redirectUrl,"connector","width=950,height=550"),t=new e(function(e,t){window.connectService=function(n){var i,s;i=r.getParameterByName(n,u()),s=r.getParameterByName(n,"status"),i&&(!s||s!=="FAIL")?e(i):t("Not Authorized")}}),t.then(function(e){localStorage.setItem(o.parameterName,e)},function(e){return e}),t}var o=t[i];if(typeof o!="object")throw new Error("Invalid source");return{isConnected:a,disconnect:f,connect:l}}}),define("src/services/bi/events-ids",[],function(){"use strict";return{severity:{info:10,warning:20,error:30,fatal:40},BIEventsIds:{"folder.create":"112","folder.rename":"115","folder.remove":"117","item.remove":"118",responseTime:"125",searchItems:"126"},BIAdaptersIds:{"private":"01","public":"02",facebook:"03",flickr:"04",instagram:"05",picasa:"06",flickrSearch:"07",googleSearch:"08"},BIAdaptersRequestsIds:{"folders.list":"01","folder.create":"02","folder.rename":"03","folder.remove":"04","items.list":"11","item.upload":"12","item.uploadByUrl":"13","item.update":"14","item.remove":"15",moveItem:"16","items.search":"17",getMoreSearchedItems:"17",getItemsByTag:"18",transcodeItem:"19"}}}),define("src/services/bi/request",["./events-ids","../../utils/utils"],function(e,t){"use strict";function n(e,n){var r=document.createElement("img");r.setAttribute("src",e+"?"+t.encodeParams(n)),r=null}function r(){return(new Date).getTime()}function i(){return"//frog.wixpress.com"}function s(t){return n(i()+"/mg",{evid:e.BIEventsIds.responseTime,call_name:t.requestName||"",ts:t.responseTime||0,result:t.isSuccess?"success":"fail",response_speed:Math.floor(t.responseSize||0/(t.responseTime/1e3)),response_size:t.responseSize})}function o(e,t,n){var i=e.name+"("+t+")",o=r()-n.startedAt;s({requestName:i,responseTime:o,isSuccess:n.isSuccess,responseSize:n.responseSize})}function u(e,t){var n=r();e.then(function(){o(t.eventTarget,t.eventName,{startedAt:n,responseSize:0,isSuccess:!0})}).catch(function(){o(t.eventTarget,t.eventName,{startedAt:n,responseSize:0,isSuccess:!1})})}function a(e,t){return t.evid=e,n(i()+"/mg",t)}function f(t,r,s){var o=s.code||"000",u=e.BIAdaptersIds[t]||"00",a=e.BIAdaptersRequestsIds[r]||"00",f=t+" "+r+": "+s.message,l=u+a+o;return n(i()+"/trg",{src:25,evid:10,iss:1,sev:e.severity.error,errc:l||"0000000",ver:"MEDIA_GALLERY_VERSION",site_id:"",httpc:o||"000",dsc:f||""})}return{report:a,error:f,benchmark:u}}),define("src/services/bi/bi",["../../events/notifier","../../events/list","./request"],function(e,t,n){"use strict";return function(r){var i=function(e,t){n.benchmark(e,t);var r=function(e,t,r){n.error(e.name,t,r)},i=function(){},s=function(e){r(t.eventTarget,t.eventName,e)};return e.then(i,s)};Object.keys(t).forEach(function(n){Object.keys(t[n]).forEach(function(s){r===!0?e.addListener(t[n][s],i):e.removeListener(t[n][s],i)})})}}),define("src/services/upload/file-to-upload",["bluebird"],function(e){"use strict";function t(e){return e.status==="waiting"||e.status==="uploading"}function n(e){e.status="failed",e.deferred.promise.catch(function(t){e.error=t}),e.deferred.promise.abort()}function r(e,t){e.status="uploading",e.uploadPromise=t.uploadFn(e.source).progress(function(t){e.deferred.promise.notify(t)}).then(function(t){e.deferred.resolve(t)}).catch(function(t){e.error=t,e.deferred.reject(t)})}function i(){var t=e.defer();return t.promise.catch(function(e){console.log(e)}),t.promise.cancellable(),t}function s(e){return{source:e.source,status:"waiting",bytesLoaded:0,deferred:i(),isAborted:!1,error:{},upload:function(){return this.isAborted||r(this,e),this.deferred.promise},abort:function(){if(!t(this))return;this.isAborted=!0;if(this.status==="waiting"){n(this);return}this.status="failed",this.uploadPromise.abort()},canRetry:function(){if(!this.error.code)return!1;var e=[-100,-201,401,403,408];return this.status==="failed"&&e.indexOf(this.error.code)!==-1?!0:!1},signUpForRetry:function(){this.status="waiting",this.isAborted=!1,this.error={},this.deferred=i()},canAbort:function(){return t(this)}}}return s}),define("src/services/upload/upload-collection",["bluebird","./file-to-upload"],function(e,t){"use strict";function f(e){return function(t){return t.name===e}}function l(e,t){typeof e=="string"&&(e=[e]),e.forEach(function(e){if(!u.indexOf(e))throw new Error("This event"+e+"is not supported by multiple file uploader");a.push({name:e,fn:t})})}function c(e,t){var n=[].slice;t=arguments.length>=2?n.call(arguments,1):[],a.filter(f(e)).forEach(function(n){n.fn.apply({event:e},t)})}function h(){return n.filter(function(e){return e.status==="waiting"}).length!==0}function p(){return n.some(function(e){return e.canRetry()})}function d(e,t){var n=e[s];return n&&n.status!=="waiting"?(s++,d(e,t),i.promise):!n&&!h()?(r=!1,s=0,i.resolve(),i.promise):!n&&h()?(s=0,d(e,t),i.promise):(t(n).finally(function(){s++,d(e,t)}),i.promise)}function v(e){return e.source.file?e.source.file.size:1}function m(){return n.reduce(function(e,t){return e+v(t)},0)}function g(e,t){switch(t.status){case"uploading":if(t.loaded<=v(e))return t.loaded;return v(e);case"succeeded":case"processing":return v(e);case"failed":return 0;default:return 0}}function y(e){return function(t){e.status=t.status,e.bytesLoaded=t.loaded,t.file=e,c("fileStatusChanged",{bytesUploaded:o+g(e,t),bytesTotal:m(),currentFileProgress:t,currentFileQueueIdx:s})}}function b(e){return e.upload()}function w(e){var t=y(e);e.deferred.promise.progress(t).then(function(n){e.serverResponse=n,t({status:"succeeded",total:v(e),loaded:v(e)}),o+=v(e)}).catch(function(n){e.serverResponse=n,t({status:"failed",total:v(e),loaded:0})})}function E(){c("uploadQueueStarted",n),d(n,b).finally(function(){c("uploadQueueFinished",n)})}function S(){if(r)throw new Error("Upload queue can not be cleared while upload is running");n.length=0,o=0}function x(s){s=s||[],!r&&!p()&&(S(),i=e.defer());var o=s.map(t);return o.forEach(function(e){w(e);var t=e.signUpForRetry;e.signUpForRetry=function(){t.apply(this,arguments),w(e),r||(r=!0,E())},n.push(e)}),c("queueChange",n),r||(r=!0,E()),o}var n=[],r=!1,i=e.defer(),s=0,o=0,u=["queueChanged","fileStatusChanged","uploadQueueStarted","uploadQueueFinished"],a=[];return{on:l,upload:x,clearQueue:S}}),define("src/wixmp",["./sources/Source","./sources/list","./events/events","./connector/connector","./services/bi/bi","./services/upload/upload-collection"],function(e,t,n,r,i,s){"use strict";return{Source:e,sources:t,events:n,bi:i,connectExternalSource:r,Uploader:s}});